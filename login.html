<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>52Rent — Увійти</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f6f6f6; margin:0; }
        .box { width: 360px; margin: 80px auto; background: #fff; padding: 24px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
        input { width:100%; padding:10px; margin:8px 0; box-sizing:border-box; }
        button { padding:10px 14px; background:#ff9900; border:none; color:#fff; cursor:pointer; border-radius:6px; }
        .hint { font-size:14px; color:#555; margin-top:12px; }
        .error { color:#b00020; }
        .links { margin-top:12px; }
    </style>
</head>
<body>

<div class="box">
    <h2>Увійти в 52Rent</h2>

    <form id="login-form">
        <div id="mode-toggle" style="margin-bottom:10px;">
            <button type="button" id="switch-to-register">Не маєте акаунту? Зареєструватися</button>
        </div>

        <label for="username">Логін</label>
        <input id="username" name="username" type="text" required />

        <div id="register-only" style="display:none;">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" />

            <label for="fullName">Повне ім'я (необов'язково)</label>
            <input id="fullName" name="fullName" type="text" />

            <label for="passwordConfirm">Підтвердіть пароль</label>
            <input id="passwordConfirm" name="passwordConfirm" type="password" />
        </div>

        <label for="password">Пароль</label>
        <input id="password" name="password" type="password" required />

        <div style="margin-top:12px; display:flex; gap:8px;">
            <button type="submit" id="submit-btn">Увійти</button>
            <button type="button" id="logout-btn">Вийти (очистити токен)</button>
        </div>

        <p class="hint">If your backend uses a different token path, update `ENDPOINTS.token` in <code>api-client.js</code>.</p>

        <p id="msg" class="error"></p>
    </form>

    <div class="links">
        <a href="index.html">Повернутись на головну</a>
    </div>
</div>

<script src="api-client.js"></script>
<script>
    const form = document.getElementById('login-form');
    const msg = document.getElementById('msg');
    const logoutBtn = document.getElementById('logout-btn');

    let mode = 'login';

    const switchBtn = document.getElementById('switch-to-register');
    const registerBlock = document.getElementById('register-only');
    const submitBtn = document.getElementById('submit-btn');

    function setMode(m) {
        mode = m;
        if (mode === 'register') {
            registerBlock.style.display = 'block';
            submitBtn.innerText = 'Зареєструватися';
            switchBtn.innerText = 'Вже маєте акаунт? Увійти';
        } else {
            registerBlock.style.display = 'none';
            submitBtn.innerText = 'Увійти';
            switchBtn.innerText = 'Не маєте акаунту? Зареєструватися';
        }
    }

    switchBtn.addEventListener('click', () => {
        setMode(mode === 'login' ? 'register' : 'login');
        msg.innerText = '';
    });

    logoutBtn.addEventListener('click', async () => {
        try {
            await apiClient.logout();
            msg.innerText = 'Вихід успішний. Токени очищено.';
        } catch (e) {
            msg.innerText = 'Помилка виходу (проблеми з API). Токени очищено локально.';
            apiClient.clearTokens();
        }

    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msg.innerText = '';

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const email = document.getElementById('email').value.trim();
        const fullName = document.getElementById('fullName').value.trim();


        if (mode === 'login') {
            try {
                const access_token = await apiClient.login({ username, password });

                if (access_token) {
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Login failed:', error);

                let errorMsg = 'Не вдалося звʼязатися з сервером.';

                if (error && error.message) {
                    if (error.message.includes('404')) {
                        errorMsg = '404: Ендпоінт входу не знайдено.';
                    } else if (error.message.includes('Token expired')) {
                        errorMsg = 'Сесія закінчилася, увійдіть знову.';
                    } else if (error.message.includes('credentials')) {
                        errorMsg = 'Не знайдено активного акаунту з такими обліковими даними.';
                    } else {
                        errorMsg = error.message;
                    }
                }
                msg.innerText = errorMsg;
            }
            return;
        }

        const passwordConfirm = document.getElementById('passwordConfirm').value;

        if (!password || !passwordConfirm) {
            msg.innerText = 'Введіть пароль і підтвердження пароля.';
            return;
        }

        if (password !== passwordConfirm) {
            msg.innerText = 'Паролі не співпадають.';
            return;
        }

        const userPayload = {
            username: username || email,
            password: password,
        };
        if (email) userPayload.email = email;
        if (fullName) userPayload.full_name = fullName;

        try {
            console.log('Attempting registration with payload:', userPayload);
            const registerRes = await fetch(ENDPOINTS.register, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userPayload),
            });

            if (!registerRes.ok) {
                const err = await registerRes.json().catch(() => ({}));
                console.error('Register response error:', err);
                throw new Error(err.username?.[0] || err.email?.[0] || err.detail || err.message || `Register failed: ${registerRes.status}`);
            }

            console.log('Registration successful. Attempting auto-login.');
            const access_token = await apiClient.login({ username: userPayload.username, password });

            if (access_token) {
                window.location.href = 'index.html';
            }
        } catch (error) {
            console.error('Registration failed:', error);

            let errorMsg = 'Не вдалося зареєструватися. Перевірте дані та спробуйте знову.';

            if (error && error.message) {
                if (error.message.includes('404')) {
                    errorMsg = '404: Ендпоінт для реєстрації не знайдено.';
                } else if (error.message.includes('already exists') || error.message.includes('unique')) {
                    errorMsg = 'Користувач з цим логіном або email вже існує.';
                } else {
                    errorMsg = `Помилка: ${error.message}`;
                }
            }
            msg.innerText = errorMsg;
        }
    });
</script>

</body>
</html>
